<!-- 
Gene Lee
11216720
 -->

<html>

	<head>
		<link rel="stylesheet" type="text/css" href="style.css">
	</head>

	<script language="JavaScript">

		// For simplicity, use this hard-coded URL as the base URL for your 
		// requests. Use XMLHttpRequest and have the URL be g_serviceURL 
		// plus a concatenated portion as appropriate.
		var g_serviceURL = "http://localhost:8080/";

		function PageLoaded()
		{
			document.body.innerHTML = "<br><br><table id='headers'> <tr><th>Name</th> <th>Date Modified</th> <th>Size (B)</th> <th>Type</th> </tr> <tr> <td colspan='4'>&nbsp;</td></tr> </table>";
			
			// XMLHttpRequest
			getLists();
		}

		// work with the response to generate the dir dynamically
		function onLoadEndListener () 
		{
			var actualJson = JSON.parse(this.responseText);
			var filesList = actualJson.file_list;
			// var dirName = this.responseURL.split(/[/,\\]+/).pop();
			// dirName = decodeURI(dirName); // url might have the characters encoded
			
			var node = document.body;

			var divIdStartIndex = this.responseURL.indexOf("lists/");
			var path = this.responseURL.substr(divIdStartIndex + 6);
			path = decodeURI(path); // the DIV ID is the path

			if (path !== "") 
			{ // must be for a sub dir
				node = document.getElementById(path);
				if (node.hasChildNodes()) { // if it is already showing its contents 'toggle' to remove
					while (node.hasChildNodes()) {
					    node.removeChild(node.lastChild);
					}
					return;
				}

				// get the path 
				// var parents = getParents(node.parentNode, []);
				// for (var i = parents.length - 1; i > -1; i--) { // get the parents working backwards
				// 	path += (parents[i].id + "/");
				// }
				// path += dirName;
			}

			for (var item of filesList) 
			{
				var divID = path + "/" + item.name; // to make DIV unique to show subdirs, use the path as the id
				
				var table = document.createElement("table");
				if (item.type == "file") {
					var tr = table.insertRow();
					var td = tr.insertCell();
					td.innerHTML = getFile(item.name, path); // make it into a link
				} 
				else { // a directory
					var tr = table.insertRow();
					tr.setAttribute("class", "dir");
					tr.setAttribute("onClick", "getLists('" + divID + "')");
					tr.style.backgroundColor = "silver";
					var td = tr.insertCell();
					td.innerHTML = item.name;
				}

				/// other stats
				td = tr.insertCell();
				td.innerHTML = item.mtime;
				td = tr.insertCell();
				td.innerHTML = item.size;
				td = tr.insertCell();
				td.innerHTML = item.type;

				// add extra in case for subdir 
				tr = table.insertRow();
				td = tr.insertCell();
				td.setAttribute("style", "padding-left:20px;");
				td.setAttribute("colspan", "4;");
				console.log("path = " + path + "/" + item.name);
				td.innerHTML = "<div id='" + divID + "'></div>";

				node.appendChild(table);
			}
		}

		// XMLHttpRequest to the server
		function getLists(dirName) 
		{
			if (dirName == undefined || dirName === null) {
				dirName = "";
			}
			dirName = encodeURI(dirName);  // for folders that have a space
			var oReq = new XMLHttpRequest();
			oReq.addEventListener("load", onLoadEndListener);
			oReq.open("GET", g_serviceURL + "lists/" + dirName);
			oReq.send();
		}

		// converts name of file into a hyperlink
		function getFile (name, dirName) 
		{
			if (dirName == "" || dirName == undefined || dirName === null) { // the root dir
				return "<a href='" + g_serviceURL + "files/" + name + "' target='_blank'><div style='height:100%;width:100%'>" + name +  "</a>";
			}
			// all sub dirs
			dirName = encodeURI(dirName);  // for folders that have a space
			return "<a href='" + g_serviceURL + "files/" + dirName + "/" + name + "' target='_blank'><div style='height:100%;width:100%'>" + name +  "</a>";
		}

		// get parent dirs, which are parents DIV elements
		function getParents (node, parentArray) 
		{
		    if (node.tagName === 'DIV') {
		    	parentArray.push(node); // add the parent
		    }
		    // do recursion until BODY is reached
		    if (node.tagName !== 'BODY') {
		    	return getParents(node.parentNode, parentArray);
		    }
		    else {
		    	return parentArray;
		    }
		}

	</script>

	<body onload="PageLoaded()">
		(loading...)	
	</body>

</html>